<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automated Aptitude Assessment</title>
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF-autotable plugin for creating tables in PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for better UI/UX */
        .card {
            background-color: #1f2937; /* bg-gray-800 */
            border: 1px solid #374151; /* border-gray-700 */
            border-radius: 0.75rem; /* rounded-xl */
            padding: 2rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn {
            display: inline-block;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .btn-primary {
            background-color: #3b82f6; /* bg-blue-600 */
            color: white;
        }
        .btn-primary:hover {
            background-color: #2563eb; /* bg-blue-700 */
        }
         .btn-primary:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .btn-secondary {
            background-color: #4b5563; /* bg-gray-600 */
            color: white;
        }
        .btn-secondary:hover {
             background-color: #374151; /* bg-gray-700 */
        }
        .input-field, .textarea-field {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #374151; /* bg-gray-700 */
            border: 1px solid #4b5563; /* border-gray-600 */
            color: white;
        }
        .input-field:focus, .textarea-field:focus {
            outline: none;
            border-color: #3b82f6; /* border-blue-600 */
            box-shadow: 0 0 0 2px #1e40af; /* ring-blue-500 */
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div id="main-container" class="w-full max-w-3xl">
        
        <div class="text-center mb-4 text-gray-400">
            <p>Viewing Student page. Add <code class="bg-gray-700 p-1 rounded">#teacher</code> to the URL to access the Teacher Panel.</p>
        </div>

        <!-- Teacher View -->
        <div id="teacher-view" class="hidden card">
            <h1 class="text-3xl font-bold mb-6">Teacher Dashboard</h1>
            <div class="space-y-6">
                <!-- Student List Setup -->
                 <div>
                    <label for="students-list" class="font-semibold mb-2 block">Authorized Student Emails (comma-separated):</label>
                    <textarea id="students-list" class="textarea-field" rows="4" placeholder="student1@college.edu, student2@college.edu"></textarea>
                </div>
                <!-- Timer Setup -->
                <div class="flex items-center gap-4">
                    <label for="timer-input" class="font-semibold whitespace-nowrap">Set Test Duration (minutes):</label>
                    <input type="number" id="timer-input" class="input-field w-24" value="10" min="1">
                </div>
                <!-- Controls -->
                <div class="flex flex-wrap gap-4 items-center">
                    <button id="start-test-btn" class="btn btn-primary flex-grow">
                        <span id="start-text">Start Test</span>
                        <div id="start-loader" class="loader hidden mx-auto"></div>
                    </button>
                    <button id="download-results-btn" class="btn btn-secondary flex-grow" disabled>End Test & Download Results PDF</button>
                </div>
                <div id="test-status-teacher" class="text-center text-lg font-medium text-yellow-400 p-3 bg-gray-700 rounded-lg">
                    Test has not started yet.
                </div>
                 <!-- Leaderboard -->
                <div>
                    <h2 class="text-2xl font-semibold mb-4">Live Leaderboard</h2>
                    <div id="leaderboard" class="bg-gray-700 p-4 rounded-lg min-h-[150px]">
                        <p class="text-gray-400">Waiting for submissions...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student View -->
        <div id="student-view" class="hidden card">
            <!-- Student Login -->
            <div id="student-login">
                <h1 class="text-3xl font-bold mb-2">Student Assessment</h1>
                <p class="text-gray-400 mb-6">Enter your college-provided email to begin.</p>
                <div class="space-y-4">
                    <input type="email" id="student-email" class="input-field" placeholder="your.email@college.edu">
                    <button id="login-btn" class="btn btn-primary w-full">Verify & Enter Test</button>
                    <p id="error-message" class="text-red-400 text-center hidden">Email not authorized or test is not active.</p>
                </div>
            </div>
            <!-- Quiz Container -->
            <div id="quiz-container" class="hidden">
                 <div class="flex justify-between items-center mb-6">
                    <h1 class="text-3xl font-bold">Aptitude Test</h1>
                    <div id="timer" class="text-2xl font-bold bg-red-600 px-4 py-2 rounded-lg">10:00</div>
                </div>
                <div id="quiz-status" class="text-center p-8 bg-gray-700 rounded-lg">
                    <h2 class="text-2xl font-semibold">Waiting for the teacher to start the test...</h2>
                    <p class="text-gray-400 mt-2">The questions will appear here once the test begins.</p>
                </div>
                <div id="question-area" class="hidden space-y-8">
                    <!-- Questions will be injected here -->
                </div>
                 <button id="submit-btn" class="btn btn-primary w-full mt-8 hidden">Submit Answers</button>
            </div>
             <!-- Student Result -->
            <div id="student-result" class="hidden text-center">
                <h1 class="text-4xl font-bold text-green-400 mb-4">Submission Successful!</h1>
                <p class="text-xl">Your score and rank will be shared by your teacher.</p>
                <p class="text-gray-400 mt-2">You may now close this window.</p>
            </div>
        </div>

    </div>

    <script>
        const TEST_STORAGE_KEY = 'liveAptitudeTestState';

        // --- DOM ELEMENTS ---
        const teacherView = document.getElementById('teacher-view');
        const studentView = document.getElementById('student-view');
        
        // Teacher elements
        const timerInput = document.getElementById('timer-input');
        const studentsListInput = document.getElementById('students-list');
        const startTestBtn = document.getElementById('start-test-btn');
        const downloadResultsBtn = document.getElementById('download-results-btn');
        const testStatusTeacher = document.getElementById('test-status-teacher');
        const leaderboard = document.getElementById('leaderboard');
        const startLoader = document.getElementById('start-loader');
        const startText = document.getElementById('start-text');

        // Student elements
        const studentLogin = document.getElementById('student-login');
        const quizContainer = document.getElementById('quiz-container');
        const studentEmailInput = document.getElementById('student-email');
        const loginBtn = document.getElementById('login-btn');
        const errorMessage = document.getElementById('error-message');
        const timerDisplay = document.getElementById('timer');
        const quizStatus = document.getElementById('quiz-status');
        const questionArea = document.getElementById('question-area');
        const submitBtn = document.getElementById('submit-btn');
        const studentResultView = document.getElementById('student-result');
        
        // --- UTILITY FUNCTIONS ---
        // Decodes HTML entities from API response (e.g., &quot; -> ")
        function decodeHTMLEntities(text) {
            const textArea = document.createElement('textarea');
            textArea.innerHTML = text;
            return textArea.value;
        }

        // --- ROUTING & VIEW MANAGEMENT ---
        function handleRouting() {
            const hash = window.location.hash;
            if (hash === '#teacher') {
                studentView.classList.add('hidden');
                teacherView.classList.remove('hidden');
                // Sync teacher view with current state from localStorage
                syncTeacherDashboard();
            } else {
                teacherView.classList.add('hidden');
                studentView.classList.remove('hidden');
            }
        }

        window.addEventListener('DOMContentLoaded', handleRouting);
        window.addEventListener('hashchange', handleRouting);

        // Listen for storage changes to update leaderboard in real-time
        window.addEventListener('storage', (event) => {
            if (event.key === TEST_STORAGE_KEY && window.location.hash === '#teacher') {
                 syncTeacherDashboard();
            }
        });

        // --- TEACHER LOGIC ---
        function syncTeacherDashboard() {
            const state = JSON.parse(localStorage.getItem(TEST_STORAGE_KEY));
            if (state && state.isStarted) {
                startTestBtn.disabled = true;
                timerInput.disabled = true;
                studentsListInput.disabled = true;
                startText.textContent = "Test is Live";
                startTestBtn.classList.remove('btn-primary');
                startTestBtn.classList.add('bg-green-600');
                downloadResultsBtn.disabled = false;
                testStatusTeacher.textContent = `Test is LIVE for ${state.durationMinutes} minutes!`;
                testStatusTeacher.classList.remove('text-yellow-400');
                testStatusTeacher.classList.add('text-green-400');
                updateLeaderboard(state.submissions);
            } else {
                // Reset UI if no active test
                startTestBtn.disabled = false;
                timerInput.disabled = false;
                studentsListInput.disabled = false;
                startText.textContent = "Start Test";
                startTestBtn.classList.add('btn-primary');
                startTestBtn.classList.remove('bg-green-600');
                downloadResultsBtn.disabled = true;
                testStatusTeacher.textContent = "Test has not started yet.";
                testStatusTeacher.classList.add('text-yellow-400');
                testStatusTeacher.classList.remove('text-green-400');
                leaderboard.innerHTML = '<p class="text-gray-400">Waiting for submissions...</p>';
            }
        }

        startTestBtn.addEventListener('click', async () => {
            const studentEmails = studentsListInput.value.split(',').map(e => e.trim().toLowerCase()).filter(e => e);
            if(studentEmails.length === 0) {
                alert('Please enter at least one student email.');
                return;
            }

            startLoader.classList.remove('hidden');
            startText.classList.add('hidden');
            startTestBtn.disabled = true;

            try {
                // Fetch automated questions from Open Trivia Database API
                const response = await fetch('https://opentdb.com/api.php?amount=10&category=18&difficulty=medium&type=multiple');
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const formattedQuestions = data.results.map(q => {
                        const options = [...q.incorrect_answers, q.correct_answer].map(decodeHTMLEntities);
                        // Shuffle options
                        for (let i = options.length - 1; i > 0; i--) {
                            const j = Math.floor(Math.random() * (i + 1));
                            [options[i], options[j]] = [options[j], options[i]];
                        }
                        return {
                            question: decodeHTMLEntities(q.question),
                            options: options,
                            answer: decodeHTMLEntities(q.correct_answer)
                        };
                    });

                    const newState = {
                        isStarted: true,
                        durationMinutes: parseInt(timerInput.value, 10) || 10,
                        questions: formattedQuestions,
                        authorizedStudents: studentEmails,
                        submissions: []
                    };
                    
                    localStorage.setItem(TEST_STORAGE_KEY, JSON.stringify(newState));
                    syncTeacherDashboard(); // Update UI based on new state
                } else {
                    throw new Error("Failed to fetch questions.");
                }

            } catch(error) {
                console.error("API Error:", error);
                alert('Could not fetch questions from the API. Please try again.');
                startTestBtn.disabled = false;
            } finally {
                startLoader.classList.add('hidden');
                startText.classList.remove('hidden');
            }
        });
        
        downloadResultsBtn.addEventListener('click', () => {
            const state = JSON.parse(localStorage.getItem(TEST_STORAGE_KEY));
            generatePDF(state);
            localStorage.removeItem(TEST_STORAGE_KEY);
            syncTeacherDashboard(); // Reset UI
        });

        function updateLeaderboard(submissions = []) {
             if (submissions.length === 0) {
                leaderboard.innerHTML = '<p class="text-gray-400">Waiting for submissions...</p>';
                return;
            }
            const sortedSubmissions = [...submissions].sort((a, b) => {
                if (b.score !== a.score) return b.score - a.score;
                return a.timeTakenSeconds - b.timeTakenSeconds;
            });

            leaderboard.innerHTML = '';
            const ol = document.createElement('ol');
            ol.className = 'list-decimal list-inside space-y-2';

            sortedSubmissions.slice(0, 10).forEach((sub, index) => {
                const li = document.createElement('li');
                li.className = 'p-2 rounded ' + (index < 3 ? 'bg-gray-600' : '');
                li.textContent = `${sub.email} - Score: ${sub.score}/${JSON.parse(localStorage.getItem(TEST_STORAGE_KEY)).questions.length}`;
                ol.appendChild(li);
            });
            leaderboard.appendChild(ol);
        }

        function generatePDF(state) {
            if (!state) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dateStr = new Date().toISOString().split('T')[0];

            doc.setFontSize(20);
            doc.text("Aptitude Test Results", 105, 20, null, null, "center");
            doc.setFontSize(12);
            doc.text(`Date: ${dateStr}`, 105, 28, null, null, "center");

            const rankedSubmissions = [...state.submissions].sort((a, b) => {
                 if (b.score !== a.score) return b.score - a.score;
                 return a.timeTakenSeconds - b.timeTakenSeconds;
            });
            const tableColumn = ["Rank", "Student Email", "Score", "Time Taken (s)"];
            const tableRows = rankedSubmissions.map((sub, index) => [
                index + 1,
                sub.email,
                `${sub.score} / ${state.questions.length}`,
                sub.timeTakenSeconds
            ]);
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40 });
            doc.save(`results_${dateStr}.pdf`);
        }

        // --- STUDENT LOGIC ---
        loginBtn.addEventListener('click', () => {
            const email = studentEmailInput.value.trim().toLowerCase();
            const state = JSON.parse(localStorage.getItem(TEST_STORAGE_KEY));
            
            if (state && state.isStarted && state.authorizedStudents.includes(email)) {
                if (state.submissions.find(s => s.email === email)) {
                    errorMessage.textContent = 'You have already submitted this test.';
                    errorMessage.classList.remove('hidden');
                    return;
                }
                studentLogin.classList.add('hidden');
                quizContainer.classList.remove('hidden');
                startQuizForStudent(email, state);
            } else if (!state || !state.isStarted) {
                errorMessage.textContent = 'The test has not been started by the teacher yet.';
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.textContent = 'This email is not authorized for the test.';
                errorMessage.classList.remove('hidden');
            }
        });

        function startQuizForStudent(email, state) {
            quizStatus.classList.add('hidden');
            questionArea.classList.remove('hidden');
            submitBtn.classList.remove('hidden');
            
            questionArea.innerHTML = '';
            state.questions.forEach((q, index) => {
                const questionEl = document.createElement('div');
                questionEl.className = 'bg-gray-700 p-6 rounded-lg';
                let optionsHTML = q.options.map(option => `
                    <label class="block p-3 rounded-md hover:bg-gray-600 cursor-pointer transition-colors">
                        <input type="radio" name="question-${index}" value="${option}" class="mr-3">
                        ${option}
                    </label>
                `).join('');
                questionEl.innerHTML = `
                    <p class="text-lg font-semibold mb-4">${index + 1}. ${q.question}</p>
                    <div class="space-y-2">${optionsHTML}</div>
                `;
                questionArea.appendChild(questionEl);
            });
            startTimer(email, state);
        }
        
        let studentTimerInterval;
        let timeRemaining;
        let startTime;

        function startTimer(email, state) {
            timeRemaining = state.durationMinutes * 60;
            startTime = Date.now();
            
            const updateDisplay = () => {
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            };
            updateDisplay();

            studentTimerInterval = setInterval(() => {
                timeRemaining--;
                updateDisplay();
                if (timeRemaining <= 0) {
                    clearInterval(studentTimerInterval);
                    submitQuiz(email); // Auto-submit
                }
            }, 1000);
        }

        submitBtn.addEventListener('click', () => {
            const email = studentEmailInput.value.trim().toLowerCase();
            submitQuiz(email);
        });

        function submitQuiz(email) {
            clearInterval(studentTimerInterval);

            const state = JSON.parse(localStorage.getItem(TEST_STORAGE_KEY));
            if (!state) return; // Test might have been ended by teacher

            let score = 0;
            state.questions.forEach((q, index) => {
                const selectedOption = document.querySelector(`input[name="question-${index}"]:checked`);
                if (selectedOption && selectedOption.value === q.answer) {
                    score++;
                }
            });

            const timeTakenSeconds = Math.round((Date.now() - startTime) / 1000);
            
            state.submissions.push({ email, score, timeTakenSeconds });
            localStorage.setItem(TEST_STORAGE_KEY, JSON.stringify(state)); // Update state with new submission

            quizContainer.classList.add('hidden');
            studentResultView.classList.remove('hidden');
        }
    </script>
</body>
</html>

